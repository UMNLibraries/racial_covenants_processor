<c-vars deed_year_data_json block_cov_data_json />

<script id="deed-year-data" type="application/json">
{{ deed_year_data_json|safe }}
</script>

<script id="city-data" type="application/json">
{{ city_data_json|safe }}
</script>

<div class="workflow-charts grid-l gap-m">
  <div class="chart-wrapper item-half">
    <div
      x-data="barChart('deed-year-data', 'deedYearChart', {
        title: 'Covenanted Parcels by Deed Year',
        labelKey: 'deed_year',
        dataKey: 'count',
        xAxisLabel: 'Deed Year',
        yAxisLabel: 'Number of Parcels',
        backgroundColor: 'rgba(255, 99, 132, 0.7)',
        borderColor: 'rgb(255, 99, 132)'
      })"
      class="chart-container"
    >
      <canvas x-ref="chartCanvas"></canvas>
    </div>
  </div>

  <div class="chart-wrapper item-half">
    <div
      x-data="barChart('city-data', 'cityChart', {
        title: 'Covenanted Parcels by City',
        labelKey: 'city',
        dataKey: 'count',
        xAxisLabel: 'City',
        yAxisLabel: 'Number of Parcels',
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgb(54, 162, 235)'
      })"
      class="chart-container"
    >
      <canvas x-ref="chartCanvas"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  function barChart(dataId, chartName, config) {
    return {
      chartData: [],
      chartInstance: null,

      init() {
        try {
          const dataElement = document.getElementById(dataId);
          if (dataElement) {
            this.chartData = JSON.parse(dataElement.textContent);
            this.$nextTick(() => {
              this.createChart();
            });
          }
        } catch (e) {
          console.error(`Error parsing ${chartName} data:`, e);
        }
      },

      createChart() {
        const labels = this.chartData.map(item => item[config.labelKey]);
        const data = this.chartData.map(item => item[config.dataKey]);

        const ctx = this.$refs.chartCanvas.getContext('2d');
        this.chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: config.title,
                data: data,
                backgroundColor: config.backgroundColor,
                borderColor: config.borderColor,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: config.title
              },
              legend: {
                display: false,
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: config.yAxisLabel
                }
              },
              x: {
                title: {
                  display: true,
                  text: config.xAxisLabel
                }
              }
            }
          }
        });
      }
    }
  }
</script>

<style>
  .workflow-charts {
    margin: 2rem 0;
  }
  .workflow-charts .chart-wrapper {
    min-width: 0;
  }
  .workflow-charts .chart-container {
    position: relative;
    width: 100%;
    aspect-ratio: 4 / 3;
  }
</style>
