{% load humanize static %}

<c-layouts.base>
<div class="stack">

  <section>
    <a href="https://mappingprejudice.umn.edu/" target="_blank" style="float: left; margin-right: 1em; margin-bottom: 0.5em;"><img src="{% static 'images/MappingPrejudice_C_600.png' %}" width="120" height="120" alt="Mapping Prejudice" /></a>
    <p>The Deed Machine is a multi-language set of tools that use OCR and crowdsourced transcription to identify racially restrictive covenant language, then map the results.</p>
    <p>The Deed Machine was created at Mapping Prejudice at the University of Minnesota Libraries. Current collaborators include Michael Corey, David Naughton, Tyler Fisher, Katlyn Alapati, Mike Tigas, and the University of Minnesota Libraries IT staff.</p>
    <h2>Workflows</h2>
    <div x-data="workflowTable()">
      <table>
        <thead>
          <tr>
            <th @click="sort('name')" style="cursor: pointer;">
              Workflow <span x-show="sortKey === 'name'" x-text="sortAsc ? '↑' : '↓'"></span>
            </th>
            <th @click="sort('mapped')" style="cursor: pointer; text-align: right;">
              Mapped <span x-show="sortKey === 'mapped'" x-text="sortAsc ? '↑' : '↓'"></span>
            </th>
            <th @click="sort('lastUpdate')" style="cursor: pointer; text-align: right;">
              Last Updated <span x-show="sortKey === 'lastUpdate'" x-text="sortAsc ? '↑' : '↓'"></span>
            </th>
          </tr>
        </thead>
        <tbody>
          <template x-for="w in sorted" :key="w.id">
            <tr>
              <td><a :href="'/workflow/' + w.id" x-text="w.name"></a></td>
              <td style="text-align: right;" x-text="w.mapped.toLocaleString()"></td>
              <td style="text-align: right;" x-text="w.lastUpdateDisplay"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    <script id="workflow-data" type="application/json">
    [
      {% for item in workflow_cards %}
      {
        "id": {{ item.obj.pk }},
        "name": "{{ item.obj.workflow_name|escapejs }}",
        "mapped": {{ item.mapped_count }},
        "lastUpdate": {% if item.last_update %}"{{ item.last_update|date:'Y-m-d' }}"{% else %}null{% endif %},
        "lastUpdateDisplay": {% if item.last_update %}"{{ item.last_update|date:'M j, Y' }}"{% else %}"—"{% endif %}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
    </script>
    <script>
      function workflowTable() {
        return {
          sortKey: 'name',
          sortAsc: true,
          workflows: JSON.parse(document.getElementById('workflow-data').textContent),
          sort(key) {
            if (this.sortKey === key) {
              this.sortAsc = !this.sortAsc;
            } else {
              this.sortKey = key;
              this.sortAsc = key === 'name';
            }
          },
          get sorted() {
            return [...this.workflows].sort((a, b) => {
              let valA = a[this.sortKey];
              let valB = b[this.sortKey];
              if (valA === null) return 1;
              if (valB === null) return -1;
              if (typeof valA === 'string') {
                return this.sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
              }
              return this.sortAsc ? valA - valB : valB - valA;
            });
          }
        }
      }
    </script>
  </section>

</div>
</c-layouts.base>